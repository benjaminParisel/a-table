name: Database Restore

on:
  workflow_dispatch:
    inputs:
      backup_name:
        description: 'Nom de l artifact de backup (ex: db-backup-20250101-030000)'
        required: true
        type: string
      target_environment:
        description: 'Environnement cible'
        required: true
        type: choice
        options:
          - staging
          - production
        default: staging
      confirm_restore:
        description: 'Tapez RESTORE pour confirmer (action irréversible!)'
        required: true
        type: string

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      confirmed: ${{ steps.check.outputs.confirmed }}

    steps:
      - name: Validate confirmation
        id: check
        run: |
          if [ "${{ github.event.inputs.confirm_restore }}" != "RESTORE" ]; then
            echo "Confirmation invalide. Vous devez taper 'RESTORE' exactement."
            echo "confirmed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "confirmed=true" >> $GITHUB_OUTPUT

      - name: Warning message
        run: |
          echo "## ATTENTION - Restauration de base de données" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Backup**: ${{ github.event.inputs.backup_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environnement**: ${{ github.event.inputs.target_environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Lancé par**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Cette action va **écraser toutes les données existantes**!" >> $GITHUB_STEP_SUMMARY

  restore:
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.confirmed == 'true'
    environment: ${{ github.event.inputs.target_environment }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download backup artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ github.event.inputs.backup_name }}
          path: ./backup

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: List downloaded files
        run: |
          echo "Fichiers téléchargés:"
          ls -la ./backup/

      - name: Restore database
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          BACKUP_FILE=$(ls ./backup/*.sql.gz 2>/dev/null | head -1)

          if [ -z "$BACKUP_FILE" ]; then
            echo "Erreur: Aucun fichier de backup trouvé!"
            exit 1
          fi

          echo "Restauration depuis: $BACKUP_FILE"

          # Decompress and restore
          gunzip -c "$BACKUP_FILE" | psql "$SUPABASE_DB_URL"

          echo "Restauration terminée avec succès!"

      - name: Restore summary
        run: |
          echo "## Restauration terminée" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Statut**: Succès" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Backup utilisé**: ${{ github.event.inputs.backup_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environnement**: ${{ github.event.inputs.target_environment }}" >> $GITHUB_STEP_SUMMARY
