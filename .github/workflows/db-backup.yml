name: Database Backup

on:
  schedule:
    # Premier jour de chaque mois Ã  3h du matin (UTC)
    - cron: '0 3 1 * *'
  workflow_dispatch: # Permet de lancer manuellement

env:
  BACKUP_RETENTION_DAYS: 90
  SUPABASE_PROJECT_REF: llyqcjptpopicsotxdva

jobs:
  backup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Create backup
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BACKUP_FILE="a-table-backup-${TIMESTAMP}.sql"

          echo "Creating backup: ${BACKUP_FILE}"

          supabase db dump \
            --project-ref "${{ env.SUPABASE_PROJECT_REF }}" \
            --data-only false \
            -f "$BACKUP_FILE"

          # Compress the backup
          gzip "$BACKUP_FILE"

          echo "BACKUP_FILE=${BACKUP_FILE}.gz" >> $GITHUB_ENV
          echo "TIMESTAMP=${TIMESTAMP}" >> $GITHUB_ENV

          # Show backup size
          ls -lh "${BACKUP_FILE}.gz"

      - name: Upload backup as artifact
        uses: actions/upload-artifact@v4
        with:
          name: db-backup-${{ env.TIMESTAMP }}
          path: ${{ env.BACKUP_FILE }}
          retention-days: ${{ env.BACKUP_RETENTION_DAYS }}

      - name: Backup summary
        run: |
          echo "## Database Backup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **File**: ${{ env.BACKUP_FILE }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Size**: $(ls -lh ${{ env.BACKUP_FILE }} | awk '{print $5}')" >> $GITHUB_STEP_SUMMARY
          echo "- **Retention**: ${{ env.BACKUP_RETENTION_DAYS }} days" >> $GITHUB_STEP_SUMMARY
